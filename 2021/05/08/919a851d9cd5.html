<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>LeetCode遇上GoogleTest | 爱吃胡萝卜</title><meta name="keywords" content="LeetCode,GoogleTest"><meta name="author" content="Clsrfish"><meta name="copyright" content="Clsrfish"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="这篇文章将记录怎么用 GoogleTest 来管理 LeetCode 的测试 case，以及优化 CMakeLists 配置避免每次都需要编译、链接整个工程，最后再利用 GitHub Action 进行自动化测试。文中不会对 Google Test 细节进行介绍，感兴趣的可以去官网阅读。 如果还不了解如何使用 VSCode 和 CMake 管理你的 C++ 工程，建议先看看这篇文章。 本文基于"><meta property="og:type" content="article"><meta property="og:title" content="LeetCode遇上GoogleTest"><meta property="og:url" content="https://clsrfish.github.io/2021/05/08/919a851d9cd5.html"><meta property="og:site_name" content="爱吃胡萝卜"><meta property="og:description" content="这篇文章将记录怎么用 GoogleTest 来管理 LeetCode 的测试 case，以及优化 CMakeLists 配置避免每次都需要编译、链接整个工程，最后再利用 GitHub Action 进行自动化测试。文中不会对 Google Test 细节进行介绍，感兴趣的可以去官网阅读。 如果还不了解如何使用 VSCode 和 CMake 管理你的 C++ 工程，建议先看看这篇文章。 本文基于"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://clsrfish.github.io/img/pwa/144.png"><meta property="article:published_time" content="2021-05-08T15:13:28.000Z"><meta property="article:modified_time" content="2021-05-07T18:19:02.000Z"><meta property="article:author" content="Clsrfish"><meta property="article:tag" content="LeetCode"><meta property="article:tag" content="GoogleTest"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://clsrfish.github.io/img/pwa/144.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://clsrfish.github.io/2021/05/08/919a851d9cd5"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google_site_verification" content="ALggV8fMlqU6kz5jiwX3wgHN9jKRCZmbXpqjS6s_Ec8"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/img/pwa/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/pwa/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/pwa/favicon-16x16.png"><link rel="mask-icon" href="/img/pwa/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script async src="https://www.googletagmanager.com/gtag/js?id=UA-199327316-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-199327316-1")</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:{limitDay:365,position:"top",messagePrev:"It has been",messageNext:"days since the last update, the content of the article may be outdated."},highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:50,languages:{author:"作者: Clsrfish",link:"链接: ",source:"来源: 爱吃胡萝卜",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"mediumZoom",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"bottom-left"},source:{jQuery:"https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js",justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css"},fancybox:{js:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js",css:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"}},isPhotoFigcaption:!0,islazyload:!0,isanchor:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"LeetCode遇上GoogleTest",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2021-05-08 02:19:02"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const a=864e5*o,c={value:t,expiry:(new Date).getTime()+a};localStorage.setItem(e,JSON.stringify(c))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const a=document.createElement("script");a.src=e,a.async=!0,a.onerror=o,a.onload=a.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme"),o=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!o&&!a&&!c;if(void 0===t){if(a)activateLightMode();else if(o)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=6||e>=18?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener((function(e){void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())}))}else"light"===t?activateLightMode():activateDarkMode();const r=saveToLocal.get("global-font-size");void 0!==r&&document.documentElement.style.setProperty("--global-font-size",r+"px");GLOBAL_CONFIG_SITE.isHome&&/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><style>.app-refresh{position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease}.app-refresh-wrap{display:flex;color:#fff;height:100%;align-items:center;justify-content:center}.app-refresh-wrap a{color:#fff;text-decoration:underline;cursor:pointer}</style><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="爱吃胡萝卜" type="application/atom+xml"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/pwa/144.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">92</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">80</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">爱吃胡萝卜</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">LeetCode遇上GoogleTest</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-05-08T15:13:28.000Z" title="发表于 2021-05-08 23:13:28">2021-05-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-05-07T18:19:02.000Z" title="更新于 2021-05-08 02:19:02">2021-05-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C++</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>15分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="LeetCode遇上GoogleTest"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><blockquote><p>这篇文章将记录怎么用 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://google.github.io/googletest/">GoogleTest</a> 来管理 LeetCode 的测试 case，以及优化 CMakeLists 配置避免每次都需要编译、链接整个工程，最后再利用 GitHub Action 进行自动化测试。文中不会对 Google Test 细节进行介绍，感兴趣的可以去官网阅读。</p><p>如果还不了解如何使用 VSCode 和 CMake 管理你的 C++ 工程，建议先看看<a href="./1.VSCode%E6%90%AD%E5%BB%BAC++%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83.md">这篇文章</a>。</p><p>本文基于 macOS 10.15，Linux 环境下差别不大，后面也会提到一些 Linux 相关的配置 。</p></blockquote><hr><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>为了方便回顾每道 LeetCode 的 AC 过程，每道题的解答都在同一个 CMake 工程中进行管理，公共数据结构（比如 ListNode、TreeNode 等）使用单独的 model 模块进行管理，不同 LeetCode 就用命名空间 <code>leetcode_xxx</code> 进行隔离，通过 <code>xxx</code> 确定某次需要运行的 LeetCode 解答，整个工程统一编译链接，构建一个可执行文件。使用这种方式管理的工程目录结构大概长这样：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">├── CMakeLists.txt</span><br><span class="line">├── main.cpp</span><br><span class="line">├── build # 编译产物</span><br><span class="line">└── src</span><br><span class="line">    ├── 1.cpp</span><br><span class="line">    ├── 2.cpp</span><br><span class="line">    ├── xxx.cpp</span><br><span class="line">    ├── CMakeLists.txt</span><br><span class="line">    ├── model # 存放公共数据结构</span><br><span class="line">    │   ├── CMakeLists.txt</span><br><span class="line">    │   ├── list_node.cpp</span><br><span class="line">    │   └── list_node.hpp</span><br><span class="line">    └── utils # 存放工具函数</span><br><span class="line">        ├── CMakeLists.txt</span><br><span class="line">        ├── stl_utils.cpp</span><br><span class="line">        └── stl_utils.hpp</span><br></pre></td></tr></table></figure><p>每道 LeetCode 解答（xxx.cpp）代码结构如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> leetcode_xxx &#123;</span><br><span class="line"></span><br><span class="line">string key = <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">solutionName</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  std::cout &lt;&lt; key &lt;&lt; <span class="string">&quot;: 标题&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">  <span class="built_in">Solution</span>().<span class="built_in">solutionName</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所有 LeetCode 解答在 <code>main.cpp</code> 中用 <code>map&lt;std::string, int (*)()&gt;</code> 保存，通过指定 key 确认需要执行的 LeetCode：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span> </span>&#123;</span><br><span class="line">    std::map&lt;std::string, <span class="type">int</span> (*)()&gt; leetcodes&#123;</span><br><span class="line">      <span class="built_in">PROBLEM</span>(leetcode_xxx), ...</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    std::string lckey = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">    <span class="comment">// 通过参数指定需要执行的 LeetCode</span></span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    std::string input = std::<span class="built_in">string</span>(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> (leetcodes.<span class="built_in">count</span>(input) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      lckey = input;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      std::cout &lt;&lt; <span class="string">&quot;invalid input:&quot;</span> &lt;&lt; input &lt;&lt; <span class="string">&quot;, running &quot;</span> &lt;&lt; lckey &lt;&lt; <span class="string">&quot; instead&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="keyword">return</span> leetcodes[lckey]();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每道题解代码格式固定，可以使用 VSCode <a target="_blank" rel="noopener external nofollow noreferrer" href="https://code.visualstudio.com/docs/editor/userdefinedsnippets">Snippet</a> 避免模板代码。这样，我们就可以在 VSCode 中快速创建新的 LeetCode 题解并调试了。</p><h3 id="1-1-编译速度影响刷题体验"><a href="#1-1-编译速度影响刷题体验" class="headerlink" title="1.1. 编译速度影响刷题体验"></a>1.1. 编译速度影响刷题体验</h3><p>按照上面的方式组织代码一开始运行得还不错，在有编译缓存的情况下 <strong>F5</strong> 能够在<strong>数秒内</strong>调试运行，全量编译耗时也在一个可接受的水平（<strong>20s</strong> 左右）。但是随着刷题量越来越多，编译链接速度出现了非常明显的下降，有时候也会在办公电脑上刷题（系统版本不同），全量编译造成的糟糕开发体验也越来越不可接受。</p><p>所以需要调整 CMakeLists 配置，<strong>指定需要调试的 LeetCode ，减少参与编译的源码数量（cpp 文件）</strong>。</p><h3 id="1-2-测试-Case-编写繁琐"><a href="#1-2-测试-Case-编写繁琐" class="headerlink" title="1.2. 测试 Case 编写繁琐"></a>1.2. 测试 Case 编写繁琐</h3><p>第二个影响刷题体验的问题是测试 Case 的编写。</p><p>正如上面实例代码，所有的测试 case 都需要自己手动构造参数并检验运行结果：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> leetcode_xxx &#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 编排测试 case</span></span><br><span class="line">    std::vector&lt;std::tuple&lt;std::string, <span class="type">int</span>&gt;&gt; testCases&#123;</span><br><span class="line">        std::<span class="built_in">make_tuple</span>(<span class="string">&quot;hello&quot;</span>, <span class="number">5</span>),</span><br><span class="line">        std::<span class="built_in">make_tuple</span>(<span class="string">&quot;world&quot;</span>, <span class="number">5</span>),</span><br><span class="line">        std::<span class="built_in">make_tuple</span>(<span class="string">&quot;&quot;</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 2. 遍历测试 case</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = testCases.<span class="built_in">begin</span>(); it != testCases.<span class="built_in">end</span>(); it++) &#123;</span><br><span class="line">        std::string input;</span><br><span class="line">        <span class="type">int</span> expected;</span><br><span class="line">        std::<span class="built_in">tie</span>(input, expected) = *it;</span><br><span class="line">        <span class="type">int</span> actual = <span class="built_in">Solution</span>().<span class="built_in">charCount</span>(input);</span><br><span class="line">        <span class="comment">// 3. 组装输出日志</span></span><br><span class="line">        <span class="keyword">if</span> ( actual != expected ) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;input(&quot;</span> &lt;&lt; input &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; <span class="string">&quot; FAILED&quot;</span>&lt;&lt; std::endl</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;\texpected: &quot;</span>&lt;&lt; expected &lt;&lt; <span class="string">&quot;actual: &quot;</span>&lt;&lt; actual &lt;&lt; std::endl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;input(&quot;</span> &lt;&lt; input &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; <span class="string">&quot; PASSED&quot;</span>&lt;&lt; std::endl</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每道题都需要手动完成上面代码中的 3 个步骤，存在一定量的模板代码，入参、返回值的数量和类型也没法用 Snippet 很好解决。特别是当某个 Test Case 计算出错需要调试时，需要注释某些 Test Case 进行针对调试，轻度强迫症患者认为这种操作不够优雅。</p><h2 id="2-使用-GoogleTest-管理-TestCase"><a href="#2-使用-GoogleTest-管理-TestCase" class="headerlink" title="2. 使用 GoogleTest 管理 TestCase"></a>2. 使用 GoogleTest 管理 TestCase</h2><blockquote><p>每道 LeetCode 题解都是一个简单函数调用，非常适合单元测试。</p></blockquote><p>GooleTest 是 Google 开源的 C++ 测试、Mock 框架，基于 <strong>xUnit</strong> 架构实现，用过 xUnit 的朋友上手几乎没有额外的理解成本。GoogleTest 遵照以下理念（摘自官网）实现：</p><ol><li>Tests should be independent and repeatable. It’s a pain to debug a test that succeeds or fails as a result of other tests. googletest isolates the tests by running each of them on a different object. When a test fails, googletest allows you to run it in isolation for quick debugging.</li><li>Tests should be well organized and reflect the structure of the tested code. googletest groups related tests into test suites that can share data and subroutines. This common pattern is easy to recognize and makes tests easy to maintain. Such consistency is especially helpful when people switch projects and start to work on a new code base.</li><li>Tests should be portable and reusable. Google has a lot of code that is platform-neutral; its tests should also be platform-neutral. googletest works on different OSes, with different compilers, with or without exceptions, so googletest tests can work with a variety of configurations.</li><li>When tests fail, they should provide as much information about the problem as possible. googletest doesn’t stop at the first test failure. Instead, it only stops the current test and continues with the next. You can also set up tests that report non-fatal failures after which the current test continues. Thus, you can detect and fix multiple bugs in a single run-edit-compile cycle.</li><li>The testing framework should liberate test writers from housekeeping chores and let them focus on the test content. googletest automatically keeps track of all tests defined, and doesn’t require the user to enumerate them in order to run them.</li><li>Tests should be fast. With googletest, you can reuse shared resources across tests and pay for the set-up&#x2F;tear-down only once, without making tests depend on each other.</li></ol><p>如果上面这些理解都落实到了 GoogleTest 实现中，我们将从繁琐的测试 Case 编写中解放出来，专注于问题本身。利用 GoogleTest，我们不用手动遍历参数组合、不用在某个统一位置（<code>main.cpp</code>）手动指定需要执行那个问题（第 5 条）；当测试失败时，框架会自动输出参数和结果，并且可以运行特定参数组合的 Test Case 而不是通过注释代码实现（第 1 条，第 4 条）。</p><h3 id="2-1-添加-Google-Test-依赖"><a href="#2-1-添加-Google-Test-依赖" class="headerlink" title="2.1. 添加 Google Test 依赖"></a>2.1. 添加 Google Test 依赖</h3><p>有很多种方式添加 GoogleTest 的依赖，比如 拷贝源码或依赖静态&#x2F;动态库、git submodule 以及 CMake FetchContent。显然，第一种方式是灵活性最低的一种，既没办法快速升级新版本，还要配置好 header、.so、.a 路径，在新机器上还需要重新下载这些文件（如果把它们加入版本控制就另当别论了）。第二种方式较第一种稍好，可以快速升级并在新机器上建立环境。第三种方式是本文使用的方式，也是 GoogleTest 官方推荐的，较 git submodule，可以让 CMake 帮我们管理 gtest 项目路径变量，下面是相关配置：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># include 要求 CMake &gt;= 3.11</span></span><br><span class="line"><span class="keyword">include</span>(FetchContent)</span><br><span class="line"><span class="comment"># Google Test 官网推荐使用最新 commit，非常勇</span></span><br><span class="line">FetchContent_Declare(</span><br><span class="line">    gtest</span><br><span class="line">    GIT_REPOSITORY https://github.com/google/googletest.git</span><br><span class="line">    GIT_TAG release-<span class="number">1.10</span>.<span class="number">0</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># For Windows: Prevent overriding the parent project&#x27;s compiler/linker settings</span></span><br><span class="line"><span class="keyword">set</span>(gtest_force_shared_crt <span class="keyword">ON</span> CACHE BOOL <span class="string">&quot;&quot;</span> FORCE)</span><br><span class="line"><span class="comment"># 获取/创建 gtest 相关变量</span></span><br><span class="line">FetchContent_GetProperties(gtest)</span><br><span class="line"><span class="comment"># 注意这里的 gtest 是上面 gtest 的小写, 个人感觉全小写可读性更高.</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">NOT</span> gtest_POPULATED)</span><br><span class="line">    <span class="comment"># 下载gtest源码到指定目录</span></span><br><span class="line">    FetchContent_Populate(gtest)</span><br><span class="line">    <span class="comment"># message($&#123;gtest_SOURCE_DIR&#125; $&#123;gtest_BINARY_DIR&#125;)</span></span><br><span class="line">    <span class="comment"># 将 gtest 工程添加到编译流程</span></span><br><span class="line">    <span class="keyword">add_subdirectory</span>(<span class="variable">$&#123;gtest_SOURCE_DIR&#125;</span> <span class="variable">$&#123;gtest_BINARY_DIR&#125;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"><span class="comment"># FetchContent_Declare 后面的配置可以用下面一行配置代替.</span></span><br><span class="line"><span class="comment"># FetchContent_MakeAvailable(googletest)</span></span><br></pre></td></tr></table></figure><p>配置好后重新执行 <code>CMake: Configure</code> 就会自动下载 gtest 项目并解压到 <code>build/_dep</code>（默认目录）。</p><p><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/2021/cmake_configure.jpg" alt="CMake: Configure"></p><h3 id="2-2-创建测试程序"><a href="#2-2-创建测试程序" class="headerlink" title="2.2. 创建测试程序"></a>2.2. 创建测试程序</h3><p>接下来需要为测试创建一个 executable target，首先编写测试代码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// hello_test.cpp</span><br><span class="line">TEST(HelloTest, BasicAssertions) &#123;</span><br><span class="line">  // Expect two strings not to be equal.</span><br><span class="line">  EXPECT_STRNE(&quot;hello&quot;, &quot;world&quot;);</span><br><span class="line">  // Expect equality.</span><br><span class="line">  EXPECT_EQ(7 * 6, 42);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>TEST</code> 是一个宏函数，它定义了测试集合名称和测试 Case 名称，宏展开后会一个 <code>class</code>，类似的宏函数还有 <code>TEST_F</code>、<code>TEST_P</code>，至于它们的实现细节，以及如何做到自动收集所有的测试 Case，暂时还没来得及去探究，等后面有时间了再回过头补上。</p><p>然后修改 <code>CMakeLists.txt</code>：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启测试，非常重要</span></span><br><span class="line"><span class="keyword">enable_testing</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(</span><br><span class="line">  hello_test</span><br><span class="line">  hello_test.cpp</span><br><span class="line">)</span><br><span class="line"><span class="comment"># gtest_main 在 gtest 项目中定义，在前面用 add_subdirectory 引入了，所以这里可以直接使用</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(</span><br><span class="line">  hello_test</span><br><span class="line">  gtest_main</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(GoogleTest)</span><br><span class="line">gtest_discover_tests(hello_test)</span><br></pre></td></tr></table></figure><p><code>gtest_discover_tests</code> 使用 post-build 从 target（hello_test）中获取所有定义的测试 Case。<code>gtest_main</code> 中定义了 main 函数，会根据输入参数（–gtest_filter 等）自动执行测试 Case。</p><blockquote><p>所以即使只想执行某一个测试Case，也需要完整编译工程。<br>使用 <code>TEST_F</code> 和 <code>TEST_P</code> 也还是会存在一定模板代码，继续用 Snippet 解决。</p></blockquote><h3 id="2-3-C-TestMate-拓展"><a href="#2-3-C-TestMate-拓展" class="headerlink" title="2.3. C++ TestMate 拓展"></a>2.3. C++ TestMate 拓展</h3><p>完成上面两个步骤之后就可以编译并运行单元测试了：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cmake -S . -B build</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cmake --build build</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> build &amp;&amp; ctest</span></span><br></pre></td></tr></table></figure><p>在<a href="../../Cpp/1.VSCode%E6%90%AD%E5%BB%BAC++%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83.md">VSCode搭建C++开发环境</a>中讲解过怎么使用 VSCode <strong>F5</strong> 代替命令行一键运行，这里就不做过多赘述了。</p><p><strong>F5</strong> 虽然能快速地运行测试，但是测试 Case 的执行结果在 <strong>DEBUG CONSOLE</strong> 中不是非常直观（没有高亮显示），并且无法单独调试某个失败的 Case，粒度比较粗。这里推荐安装 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/matepek/vscode-catch2-test-adapter">C++ TestMate</a>，它会在 <strong>Test Explorer</strong> 中列举出所有的测试 Case，支持一键运行所有 Case 的同时也支持或特定 Case&#x2F;Suite 的运行、调试（见截图，实际体验会很不错）。</p><p><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://github.com/matepek/vscode-catch2-test-adapter/raw/master/resources/Screenshot_2019-05-28.png" alt="C++ TestMate"></p><p>因为 C++ TestMate 通过可执行文件列举测试 Case，安装拓展后要根据你实际的工程配置下可执行文件&#x2F;编译产物的位置：<br><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/2021/cpp_testmate_exeutables.jpg"></p><blockquote><p>如果可执行文件名带有 test 字样，并且在 build、out 等目录中，使用默认配置就可以了。</p></blockquote><p><strong>一个小坑</strong></p><p>在配置 VSCode 一键运行时掉进了一个坑，导致 <strong>F5</strong> 一键运行无法断点调试，但是用 C++ TestMate 的调试按钮就可以断点调试。但是 C++ TestMate 列举测试 Case 依赖可执行文件的构建成功，所以修改完代码需要先 <strong>build</strong> 再在 C++ TestMate 中启动调试，流程变麻烦了。</p><p>各种排查之后发现是因为添加了两个参数：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// launch.json</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CMake - Build and launch debuging(lldb)&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/build/main_test&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="comment">// cause debugger not able to attach</span></span><br><span class="line">                <span class="string">&quot;--gtest_list_tests&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--gtest_output=xml:$&#123;workspaceFolder&#125;/build/gtest_list.xml&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>当时是安装好 C++ TestMate 后去查看它都有哪些可以优化体验的配置，然后就看到了 <strong>Test List Caching</strong> 配置，说是能加速测试 Case 在 Test Explorer 中刷新的速度，没多想就给加上了参数，然后就掉坑了。因为实际体验这两个参数加上好像也没啥变化，所以就不要画蛇添足了。</p><p><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/2021/cpp_testmate.jpg"></p><h2 id="3-优化编译速度"><a href="#3-优化编译速度" class="headerlink" title="3. 优化编译速度"></a>3. 优化编译速度</h2><p>第 2 节中我们利用 GoogleTest 解决了测试 Case 编写繁琐的问题，现在要解决是如何优化编译速度，<strong>进一步提高刷题的幸福感</strong>。</p><p>先看下 <code>src/CMakeLists.txt</code> 的内容：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">aux_source_directory</span>(. SRC)</span><br><span class="line"><span class="keyword">add_library</span> (src <span class="variable">$&#123;SRC&#125;</span>)</span><br></pre></td></tr></table></figure><p>内容非常简单，就是将 <strong>src</strong> 目录下所有 <code>.cpp</code> 编译链接成一个 <em>libsrc.a</em> 。由于每个 <code>.c/.cc/.cxx/.cpp</code> 文件都是一个独立的编译单元，都需要独立解析 include 的 header 文件，如果 header 中有 template（STL、Boost），就会实例化相同的模板实例。LeetCode 到目前为止一共 2K+ 道题，触发一次全量编译差不多得花 30min+（MacBook pro 2017），所以随着刷题数量的增加，在编译上浪费的时间也会越来越多，体验越来越差。</p><p>所以最直接的想法就是<strong>指定需要参与编译的源文件，即指定 LeetCode 题号对应的源文件</strong>，将编译耗时保持在数秒之内。</p><blockquote><p>题解文件名按 xxx.cpp 命名，对应测试代码是 xxx_test.cpp</p></blockquote><p>下面是优化后的 <code>src/CMakeLists.txt</code>：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(LEETCODE_SRC_FILE <span class="string">&quot;ALL&quot;</span> CACHE <span class="keyword">STRING</span> <span class="string">&quot;Which src files need compiling.&quot;</span>)</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$&#123;LEETCODE_SRC_FILE&#125;</span> <span class="keyword">STREQUAL</span> <span class="string">&quot;ALL&quot;</span> <span class="keyword">OR</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="variable">$&#123;LEETCODE_SRC_FILE&#125;</span>)</span><br><span class="line">  <span class="keyword">aux_source_directory</span>(. SRC)</span><br><span class="line">  <span class="keyword">add_library</span> (src <span class="variable">$&#123;SRC&#125;</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">  <span class="keyword">add_library</span> (src <span class="variable">$&#123;LEETCODE_SRC_FILE&#125;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure><p>我们定义 <code>LEETCODE_SRC_FILE</code> 指定需要编译的源文件，然后在根目录的 <code>CMakeLists.txt</code> 中接收命令行参数并传递值给 <code>LEETCODE_SRC_FILE</code>：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="keyword">set</span>(LEETCODE_PROBLEM <span class="string">&quot;ALL&quot;</span> CACHE <span class="keyword">STRING</span> <span class="string">&quot;Choose the problem to run, all problems will be build if not specified or not found.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$&#123;LEETCODE_PROBLEM&#125;</span> <span class="keyword">STREQUAL</span> <span class="string">&quot;ALL&quot;</span>)</span><br><span class="line">    <span class="comment"># Build all.</span></span><br><span class="line">    <span class="keyword">set</span>(LEETCODE_SRC_FILE <span class="string">&quot;ALL&quot;</span> CACHE <span class="keyword">STRING</span> <span class="string">&quot;&quot;</span> FORCE)</span><br><span class="line">    <span class="keyword">aux_source_directory</span>(./<span class="keyword">test</span> TEST_SUIT_SRCS)</span><br><span class="line">    <span class="keyword">add_executable</span>(main <span class="variable">$&#123;TEST_SUIT_SRCS&#125;</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    <span class="comment"># Build single.</span></span><br><span class="line">    <span class="keyword">set</span>(LEETCODE_SRC_FILE <span class="variable">$&#123;LEETCODE_PROBLEM&#125;</span>.cpp CACHE <span class="keyword">STRING</span> <span class="string">&quot;&quot;</span> FORCE)</span><br><span class="line">    <span class="keyword">add_executable</span>(main <span class="keyword">test</span>/<span class="variable">$&#123;LEETCODE_PROBLEM&#125;</span>_test.cpp)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"><span class="keyword">add_subdirectory</span>(src)</span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure><p>这里再次定义了个类似的 <code>LEETCODE_PROBLEM</code> 变量，即“题号”，然后在编译时通过 <code>-DLEETCODE_PROBLEM=XX</code> 传递给 CMake，这样就做到了指定源码编译。</p><blockquote><p><code>set</code> 命令的用法见 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://cmake.org/cmake/help/git-stage/command/set.html">CMake 文档</a>，<code>FORCE</code> 是为了保证参数不受缓存影响而及时生效。</p></blockquote><p>对应的，再调整下 <code>tasks.json</code>，加上 <code>LEETCODE_PROBLEM</code> 参数：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="attr">&quot;tasks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;process&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C/C++: cmake debug build&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmake&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;--log-level=DEBUG&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;-DCMAKE_BUILD_TYPE=Debug&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="comment">// twoSum</span></span><br><span class="line">                <span class="string">&quot;-DLEETCODE_PROBLEM=1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="comment">// cwd: build</span></span><br><span class="line">                <span class="string">&quot;..&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>这样每次只需要修改 <code>tasks.json</code> 就可以直接 <strong>F5</strong> 调试了。</p><h2 id="4-使用-GitHub-Action-自动化测试"><a href="#4-使用-GitHub-Action-自动化测试" class="headerlink" title="4. 使用 GitHub Action 自动化测试"></a>4. 使用 GitHub Action 自动化测试</h2><p>虽然到这里我们已经可以愉快地刷题了，但是刷题过程中对数据结构的修改可能影响了已有题解，考虑到编译耗时，我们又不太可能会随时全量编译，这些未及时发现的问题就累积下来了。</p><p>这里我们可以借助 GitHub Actions 提供的 CI&#x2F;CD 能力，在 push 之后执行全量编译并执行测试，失败了还可以配置邮件通知，及时暴露问题。</p><p>这里就直接贴配置了：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span> [<span class="string">push</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">gtest:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Run</span> <span class="string">tests</span> <span class="string">on</span> <span class="string">GTest</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="comment"># 在 macOS 和 Linux 两个平台测试，提高代码可移植性.</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">os:</span> [<span class="string">macos-latest</span>, <span class="string">ubuntu-latest</span>]</span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.os</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">buildDir:</span> <span class="string">&quot;$<span class="template-variable">&#123;&#123; github.workspace &#125;&#125;</span>/build&quot;</span></span><br><span class="line">      <span class="attr">executable:</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Project</span> <span class="string">checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Get</span> <span class="string">latest</span> <span class="string">CMake</span> <span class="string">and</span> <span class="string">ninja</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">lukka/get-cmake@latest</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">CMake,</span> <span class="string">build</span> <span class="string">with</span> <span class="string">CMake</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">lukka/run-cmake@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">cmakeListsTxtPath:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.workspace</span> <span class="string">&#125;&#125;/CMakeLists.txt</span></span><br><span class="line">          <span class="attr">buildDirectory:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.buildDir</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="comment"># 不指定 LEETCODE_PROBLEM 默认是全量编译.</span></span><br><span class="line">          <span class="attr">cmakeAppendedArgs:</span> <span class="string">&quot;--log-level=DEBUG -Wdev -DCMAKE_BUILD_TYPE=Debug&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">executable</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.buildDir</span> <span class="string">&#125;&#125;/$&#123;&#123;</span> <span class="string">env.executable</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>然后可以在 README.md 中配置个<a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.github.com/en/actions/managing-workflow-runs/adding-a-workflow-status-badge">徽标</a>，显示上次自动化测试的执行结果。</p><blockquote><p>如果本地没有 Linux 环境，可以使用 docker 容器曲线救国。</p></blockquote><h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>GoogleTest 将我们从繁琐的测试 Case 中解放出来；而最小化编译使我们免于低效地等待编译；GitHub Actions 则帮助我们及时纠正不小心引入的问题。工欲善其事，必先利其器，善于利用工具，改进影响效率的瓶颈，避免陷入低效陷阱。</p><p>完整项目代码见 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Clsrfish/leetcode">https://github.com/Clsrfish/leetcode</a> 。</p><h2 id="6-参考文章"><a href="#6-参考文章" class="headerlink" title="6. 参考文章"></a>6. 参考文章</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://google.github.io/googletest/">Google Test</a></p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://cmake.org/cmake/help/latest/module/FetchContent.html">FetchContent</a></p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://cmake.org/cmake/help/git-stage/command/set.html">CMake set</a></p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://cmake.org/cmake/help/git-stage/module/GoogleTest.html">GoogleTest Module</a></p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/features/actions">GitHub Actions</a></p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.github.com/en/actions/managing-workflow-runs/adding-a-workflow-status-badge">Adding a workflow status badge</a></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">Clsrfish</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://clsrfish.github.io/2021/05/08/919a851d9cd5.html">https://clsrfish.github.io/2021/05/08/919a851d9cd5.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://clsrfish.github.io" target="_blank">爱吃胡萝卜</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/LeetCode/">LeetCode</a><a class="post-meta__tags" href="/tags/GoogleTest/">GoogleTest</a></div><div class="post_share"><div class="social-share" data-image="/img/pwa/144.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/01/18/38be76b81723.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://ms-vscode.gallerycdn.vsassets.io/extensions/ms-vscode/cpptools/1.1.3/1607049308689/Microsoft.VisualStudio.Services.Icons.Default" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">VSCode 搭建 C++ 开发环境</div></div></a></div><div class="next-post pull-right"><a href="/2021/05/14/e9ab622cfede.html"><img class="next-cover" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/2021/dangerffmpeg_screencap.jpeg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【DangerFFmpeg】开篇</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/01/11/fe653e503611.html" title="记一次 Head Buffer Overflow"><img class="cover" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/leetcode/head_buffer_overflow.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-11</div><div class="title">记一次 Head Buffer Overflow</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/pwa/144.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">Clsrfish</div><div class="author-info__description">互联网，读书，计算机</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">92</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">80</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div><a class="button--animated" id="card-info-btn" href="https://github.com/Clsrfish" rel="external nofollow noreferrer"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:clsrfish@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">《置身事内》ing...</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">1. 前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E7%BC%96%E8%AF%91%E9%80%9F%E5%BA%A6%E5%BD%B1%E5%93%8D%E5%88%B7%E9%A2%98%E4%BD%93%E9%AA%8C"><span class="toc-number">1.1.</span> <span class="toc-text">1.1. 编译速度影响刷题体验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%B5%8B%E8%AF%95-Case-%E7%BC%96%E5%86%99%E7%B9%81%E7%90%90"><span class="toc-number">1.2.</span> <span class="toc-text">1.2. 测试 Case 编写繁琐</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8-GoogleTest-%E7%AE%A1%E7%90%86-TestCase"><span class="toc-number">2.</span> <span class="toc-text">2. 使用 GoogleTest 管理 TestCase</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%B7%BB%E5%8A%A0-Google-Test-%E4%BE%9D%E8%B5%96"><span class="toc-number">2.1.</span> <span class="toc-text">2.1. 添加 Google Test 依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.2.</span> <span class="toc-text">2.2. 创建测试程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-C-TestMate-%E6%8B%93%E5%B1%95"><span class="toc-number">2.3.</span> <span class="toc-text">2.3. C++ TestMate 拓展</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BC%98%E5%8C%96%E7%BC%96%E8%AF%91%E9%80%9F%E5%BA%A6"><span class="toc-number">3.</span> <span class="toc-text">3. 优化编译速度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8-GitHub-Action-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95"><span class="toc-number">4.</span> <span class="toc-text">4. 使用 GitHub Action 自动化测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">5. 总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">6.</span> <span class="toc-text">6. 参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/29/a22615e5cdae.html" title="LSM-Tree">LSM-Tree</a><time datetime="2023-07-29T13:16:22.000Z" title="发表于 2023-07-29 21:16:22">2023-07-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/17/49937ddf50aa.html" title="Rate-limiting algorithms">Rate-limiting algorithms</a><time datetime="2023-07-17T14:17:28.000Z" title="发表于 2023-07-17 22:17:28">2023-07-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/16/44c822c98a72.html" title="Consistent hashing">Consistent hashing</a><time datetime="2023-07-16T06:24:30.000Z" title="发表于 2023-07-16 14:24:30">2023-07-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/15/f74286649fc7.html" title="Bloom filter">Bloom filter</a><time datetime="2023-07-15T14:19:02.000Z" title="发表于 2023-07-15 22:19:02">2023-07-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/12/524fd56f9760.html" title="Cache problems">Cache problems</a><time datetime="2023-07-12T13:37:02.000Z" title="发表于 2023-07-12 21:37:02">2023-07-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2023 By Clsrfish</div><div class="framework-info"><span>框架</span> <a href="https://hexo.io" rel="external nofollow noreferrer">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a href="https://github.com/jerryc127/hexo-theme-butterfly" rel="external nofollow noreferrer">Butterfly</a></div><div class="footer_custom_text">Welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><div class="app-refresh" id="app-refresh"><div class="app-refresh-wrap"><label>✨ 网站已更新最新版本 👉</label> <a href="javascript:void(0)" rel="external nofollow noreferrer" onclick="location.reload()">点击刷新</a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"已更新最新版本",backgroundColor:t,duration:5e5,pos:e,actionText:"点击刷新",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",(function(){showNotification()})),window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js")})))</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="true" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>