<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>撸个简单的 JSbridge | 爱吃胡萝卜</title><meta name="keywords" content="Webview,JSB"><meta name="author" content="Clsrfish"><meta name="copyright" content="Clsrfish"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="这两年 Web 技术栈一直在努力地向移动端和后端延展（这里没有引战的意思），当然这也是技术发展所带来的必然结果。移动互联网早期主要以原生开发为主，但到现在，业务不断发展，版本也需要快速迭代，原生开发效率很明显难以跟上，这时候 Web 开发的优势就显现出来了。"><meta property="og:type" content="article"><meta property="og:title" content="撸个简单的 JSbridge"><meta property="og:url" content="https://clsrfish.github.io/2018/01/09/766c3d4ae9f8.html"><meta property="og:site_name" content="爱吃胡萝卜"><meta property="og:description" content="这两年 Web 技术栈一直在努力地向移动端和后端延展（这里没有引战的意思），当然这也是技术发展所带来的必然结果。移动互联网早期主要以原生开发为主，但到现在，业务不断发展，版本也需要快速迭代，原生开发效率很明显难以跟上，这时候 Web 开发的优势就显现出来了。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><meta property="article:published_time" content="2018-01-09T13:59:21.000Z"><meta property="article:modified_time" content="2023-08-05T13:23:07.812Z"><meta property="article:author" content="Clsrfish"><meta property="article:tag" content="Webview"><meta property="article:tag" content="JSB"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://clsrfish.github.io/2018/01/09/766c3d4ae9f8"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google_site_verification" content="ALggV8fMlqU6kz5jiwX3wgHN9jKRCZmbXpqjS6s_Ec8"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/img/pwa/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/pwa/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/pwa/favicon-16x16.png"><link rel="mask-icon" href="/img/pwa/safari-pinned-tab.svg" color="#5bbad5"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script async src="https://www.googletagmanager.com/gtag/js?id=UA-199327316-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-199327316-1")</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:{limitDay:365,position:"top",messagePrev:"It has been",messageNext:"days since the last update, the content of the article may be outdated."},highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:50,languages:{author:"作者: Clsrfish",link:"链接: ",source:"来源: 爱吃胡萝卜",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"mediumZoom",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"bottom-left"},source:{jQuery:"https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js",justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css"},fancybox:{js:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js",css:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"}},isPhotoFigcaption:!0,islazyload:!0,isanchor:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"撸个简单的 JSbridge",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-08-05 21:23:07"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const a=864e5*o,c={value:t,expiry:(new Date).getTime()+a};localStorage.setItem(e,JSON.stringify(c))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const a=document.createElement("script");a.src=e,a.async=!0,a.onerror=o,a.onload=a.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme"),o=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!o&&!a&&!c;if(void 0===t){if(a)activateLightMode();else if(o)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=6||e>=18?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener((function(e){void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())}))}else"light"===t?activateLightMode():activateDarkMode();const r=saveToLocal.get("global-font-size");void 0!==r&&document.documentElement.style.setProperty("--global-font-size",r+"px");GLOBAL_CONFIG_SITE.isHome&&/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><style>.app-refresh{position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease}.app-refresh-wrap{display:flex;color:#fff;height:100%;align-items:center;justify-content:center}.app-refresh-wrap a{color:#fff;text-decoration:underline;cursor:pointer}</style><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="爱吃胡萝卜" type="application/atom+xml"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/pwa/144.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">92</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">80</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">爱吃胡萝卜</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">撸个简单的 JSbridge</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2018-01-09T13:59:21.000Z" title="发表于 2018-01-09 21:59:21">2018-01-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-05T13:23:07.812Z" title="更新于 2023-08-05 21:23:07">2023-08-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/">Android</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Hybrid/">Hybrid</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>11分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="撸个简单的 JSbridge"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>这两年 Web 技术栈一直在努力地向移动端和后端延展（这里没有引战的意思），当然这也是技术发展所带来的必然结果。移动互联网早期主要以原生开发为主，但到现在，业务不断发展，版本也需要快速迭代，原生开发效率很明显难以跟上，这时候 Web 开发的优势就显现出来了。</p><span id="more"></span><p>（废话讲的差不多了）</p><h2 id="Hybrid"><a href="#Hybrid" class="headerlink" title="Hybrid"></a>Hybrid</h2><p>Hybrid App 中文名叫：混合App，即原生应用和 WebApp 的结合体，它兼顾了 <strong>原生应用</strong> 的体验和 <strong>WebApp</strong> 的开发效率（这里定义应该是狭义的）。<br>最常见的 Hybrid 的实现方式是通过 JSBridge 来打通 Native Code 和 JavaScript 之间的隔阂。<br>这篇文章中我们一起来简单实现一个 JSBridge。</p><h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>在 Android 上实现 Hybrid 是通过 Webview 来实现的，所以下面再简单过一下 Webview 的一些基本知识。</p><h3 id="Webview"><a href="#Webview" class="headerlink" title="Webview"></a>Webview</h3><p>通常我们会使用 <code>webview.loadUrl(url)</code> 来加载一个页面，这个方法还可以用来执行 JS 代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webview.loadUrl(<span class="string">&quot;javascript:console.log\(called by Native\)&quot;</span>);</span><br></pre></td></tr></table></figure><p>这里通过 <code>javascript</code> 这个伪协议来调用或执行 JS 代码。</p><h3 id="WebSettings"><a href="#WebSettings" class="headerlink" title="WebSettings"></a>WebSettings</h3><p>这个类主要是完成 Webview 的一些配置工作，比如允许执行 JS。要实现 JSBridge ，就必须允许执行 JS。</p><h3 id="WebviewClient"><a href="#WebviewClient" class="headerlink" title="WebviewClient"></a>WebviewClient</h3><p>这个类会收到 JS 环境中的各种事件，比如资源请求、页面加载完成、点击了一个链接等。</p><h3 id="WebChromeClient"><a href="#WebChromeClient" class="headerlink" title="WebChromeClient"></a>WebChromeClient</h3><p>这个类主要用来辅助 WebView 进行一些界面上的工作，比如弹出对话框等。</p><h2 id="通信方式"><a href="#通信方式" class="headerlink" title="通信方式"></a>通信方式</h2><p>要实现 JSBridge ，还得提供一条合适的通信通道，目前主要方式有三种：</p><ul><li>webViewClient.shouldOverrideUrlLoading(WebView,WebResourceRequest)<br>当需要加载一个新的 url 的时候，WebView 会先询问 WebViewClient 是否需要进行拦截。利用这个回调，可以构造自己的 schema ，在 url 中携带各种动作信息和参数等。这种方式一般是在 JS 中创建一个不可见的 iframe，然后改变 iframe 的 src 属性就可以了（微信就是这么实现的）。</li><li>webChromeClient.onJSPrompt(wv,url,message,defaultValue,callback)<br>还有另外两个类似的回调方法，不过因为使用频率都比这个方法高，一般都不会去占用。这里主要用到第三个参数： message ，通过它传递 Json 字符串，可以方便拿到各种信息，比上面的方式略简单一些（不是很喜欢这种方式）。</li><li>webView.addJavascriptInterface(object,name)<br>这种方式应该是效率最高、调用最自然的一种，不过在 Android 4.2 之前有安全问题，如果不需要兼容4.2 及以下版本，应该是比较推荐使用这个种方式。这种方式将 Native 中的一个对象挂载到 JS 的window 上，并命名为 name，然后 JS 中就能够通过 <code>window.name.funname(params)</code> 的方式来调用 Native 中被 JavascriptInterface 注解所标记的方法了（这里可以实现 JS 同步调用 Native ）</li></ul><p>上面的只是完成了 JS 发消息到 Native ，Native 通知 JS 可以通过 <code>webview.loadUrl(url)</code> 来实现。</p><h2 id="需要考虑的问题"><a href="#需要考虑的问题" class="headerlink" title="需要考虑的问题"></a>需要考虑的问题</h2><ul><li>通信协议<br>需要制定统一的消息格式，这个还算比较简单</li><li>回调<br>Webview 渲染线程和一般的 UI 线程不是同一线程，所以需要通过回调在子线程拿到返回值</li><li>传递信息长度<br>如果通过 <code>webViewClient.shouldOverrideUrlLoading</code> 还要注意 url 的长度，不过一般情况下是不会有这种问题的</li><li>线程<br>Native 只能在主线程调用 JS，接收到的 JS 调用在子线程</li></ul><h2 id="动手"><a href="#动手" class="headerlink" title="动手"></a>动手</h2><p>撸 JSbrdige 所需要的基本知识也就这些了，还有一些小坑点在实现的过程中来说明。<br>这里以我已经完成的 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dashMrl/JStraw">JSBridge</a> 为例来进行说明。</p><blockquote><p>因为 JavaScript 实现比较简单，所以主要讲 Native（kotlin） 的实现，</p></blockquote><h3 id="核心类说明"><a href="#核心类说明" class="headerlink" title="核心类说明"></a>核心类说明</h3><p>JSBridge 核心还是一个通信协议，所以需要一些规范化的抽象。</p><h4 id="Request-x2F-Response"><a href="#Request-x2F-Response" class="headerlink" title="Request&#x2F;Response"></a>Request&#x2F;Response</h4><p>仿照 HTTP 协议，定义出请求响应类，这里就直接看源码就 OK 了：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Native 调用 JS 或者 JS 调用 Native 的请求封装</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span>&lt;<span class="type">T</span>&gt;</span>(</span><br><span class="line">        <span class="meta">@SerializedName(<span class="string">&quot;handler_name&quot;</span>)</span><span class="comment">//对于不同功能，我们提供不同的 Handler 处理</span></span><br><span class="line">        <span class="keyword">val</span> handlerName: String,</span><br><span class="line">        <span class="meta">@SerializedName(<span class="string">&quot;callback_id&quot;</span>)</span><span class="comment">//在另外一段完成操作后进行回调用的</span></span><br><span class="line">        <span class="keyword">val</span> callbackId: <span class="built_in">Int</span>,</span><br><span class="line">        <span class="meta">@SerializedName(<span class="string">&quot;params&quot;</span>)</span><span class="comment">// Handler 处理所需要的数据</span></span><br><span class="line">        <span class="keyword">val</span> params: T</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">create</span><span class="params">(callId: <span class="type">String</span>, callbackId: <span class="type">Int</span>, params: <span class="type">T</span>)</span></span>: Request&lt;T&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> Request(callId, callbackId, params)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Native 对 JS 或者 JS 对 Native 的响应的封装</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span>&lt;<span class="type">out T</span>&gt;</span>(</span><br><span class="line">        <span class="meta">@SerializedName(<span class="string">&quot;status&quot;</span>)</span><span class="comment">//状态，成功、失败或取消</span></span><br><span class="line">        <span class="keyword">val</span> status: <span class="built_in">Int</span>,</span><br><span class="line">        <span class="meta">@SerializedName(<span class="string">&quot;msg&quot;</span>)</span><span class="comment">//状态的简单解释</span></span><br><span class="line">        <span class="keyword">val</span> msg: String,</span><br><span class="line">        <span class="meta">@SerializedName(<span class="string">&quot;body&quot;</span>)</span><span class="comment">//响应数据</span></span><br><span class="line">        <span class="keyword">val</span> <span class="keyword">data</span>: T</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">internal</span> <span class="keyword">val</span> STATUS_OK = <span class="number">0</span></span><br><span class="line">        <span class="keyword">internal</span> <span class="keyword">val</span> STATUS_FAILED = <span class="number">1</span></span><br><span class="line">        <span class="keyword">internal</span> <span class="keyword">val</span> STATUS_CANCEL = <span class="number">2</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">success</span><span class="params">(msg: <span class="type">String</span> = <span class="string">&quot;success&quot;</span>, <span class="keyword">data</span>: <span class="type">T</span>)</span></span>: Response&lt;T&gt; = Response(STATUS_OK, msg, <span class="keyword">data</span>)</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">cancel</span><span class="params">(msg: <span class="type">String</span> = <span class="string">&quot;canceled&quot;</span>)</span></span>: Response&lt;<span class="built_in">Unit</span>&gt; = Response(STATUS_CANCEL, msg, <span class="built_in">Unit</span>)</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">failed</span><span class="params">(msg: <span class="type">String</span> = <span class="string">&quot;failed&quot;</span>)</span></span>: Response&lt;<span class="built_in">Unit</span>&gt; = Response(STATUS_FAILED, msg, <span class="built_in">Unit</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="NativeHandler-lt-in-T-out-R-gt"><a href="#NativeHandler-lt-in-T-out-R-gt" class="headerlink" title="NativeHandler&lt;in T, out R&gt;"></a>NativeHandler&lt;in T, out R&gt;</h4><p>对于 JS 的请求，需要有特定的类来进行处理，这里还是直接看源码：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">NativeHandler</span>&lt;<span class="type">in T, out R</span>&gt; </span>&#123;<span class="comment">// T 表示接收请求参数类型，R 表示响应参数类型</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">name</span><span class="params">()</span></span>: String</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">handleJSCall</span><span class="params">(requestStr: <span class="type">String</span>, wv: <span class="type">WebView</span>)</span></span> &#123;<span class="comment">//kotlin 接口可以有方法实现</span></span><br><span class="line">        Log.d(<span class="string">&quot;NativeHandler&quot;</span>,requestStr)</span><br><span class="line">        <span class="keyword">val</span> request = JsonUtil.json2Obj&lt;Request&lt;T&gt;&gt;(requestStr)</span><br><span class="line">        handle(request.params, JSCallback(wv, request.callbackId))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">handle</span><span class="params">(<span class="keyword">data</span>: <span class="type">T</span>, callback: <span class="type">JSCallback</span>&lt;<span class="type">R</span>&gt;)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>应对不同类型的请求，可以通过实现不同的 NativeHandler 来实现，其中 <code>name()</code> 应该返回一个全局唯一的、易于识别的字符串用于标识这个 Handler，重写 <code>handle()</code> 来处理请求并响应。要注意的是，<code>handle()</code> 方法默认运行在子线程，所以如果想操作 UI ，还要进行线程切换（JSCallback 内部进行了线程切换）。</p><blockquote><p>最好是做到每个请求都响应一些状态，让另外一端知道请求是失败还是成功又或者取消了等</p></blockquote><h4 id="Pivot"><a href="#Pivot" class="headerlink" title="Pivot"></a>Pivot</h4><p>这个类是通信的枢纽，对 JS 的调用与接受 JS 的请求都是在这里。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">interface</span> <span class="title">IPivot</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">callJS</span><span class="params">(handlerName: <span class="type">String</span>, params: <span class="type">String</span>, callback: <span class="type">NativeCallback</span>&lt;*&gt;)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">callFromJS</span><span class="params">(handlerName: <span class="type">String</span>, request: <span class="type">String</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">responseFromJS</span><span class="params">(callbackId: <span class="type">Int</span>, <span class="keyword">data</span>: <span class="type">String</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="JStraw"><a href="#JStraw" class="headerlink" title="JStraw"></a>JStraw</h4><p>这个类用于对外暴露 API 接口，有些接口需要隐藏，所以使用 <code>internal</code> 进行修饰：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">IJStraw</span> </span>&#123;<span class="comment">//interface 不能使用 internal 所以改成 abstract class</span></span><br><span class="line">    <span class="keyword">abstract</span>  <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">callJS</span><span class="params">(handlerName: <span class="type">String</span>, <span class="keyword">data</span>: <span class="type">String</span> = <span class="string">&quot;&quot;</span>)</span></span>: NativeCallback&lt;T&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">registerNativeHandler</span><span class="params">(handler: <span class="type">NativeHandler</span>&lt;*, *&gt;)</span></span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">findNativeHandler</span><span class="params">(handlerName: <span class="type">String</span>)</span></span>: NativeHandler&lt;*, *&gt;?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">addCallback</span><span class="params">(callbackId: <span class="type">Int</span>, callback: <span class="type">NativeCallback</span>&lt;*&gt;)</span></span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">removeCallback</span><span class="params">(callbackId: <span class="type">Int</span>)</span></span>: NativeCallback&lt;*&gt;?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样，通过几行代码就可以完成 Native 调用 JS：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jstraw.callJS&lt;String&gt;(<span class="string">&quot;js_handler&quot;</span>,<span class="string">&quot;json data&quot;</span>)</span><br><span class="line">    .success &#123; result: String -&gt; toast(result) &#125;</span><br><span class="line">	.failed &#123; msg -&gt; toast(msg) &#125;</span><br><span class="line">	.canceled &#123; toast(<span class="string">&quot;canceled&quot;</span>) &#125;</span><br><span class="line">	.error &#123; e -&gt; toast(e.message.toString()) &#125;</span><br><span class="line">	.exec()</span><br></pre></td></tr></table></figure><blockquote><p>到这里，Native 端的大概轮廓就出来了，剩下的只剩下一些细节方面的东西了</p></blockquote><h4 id="JS-实现"><a href="#JS-实现" class="headerlink" title="JS 实现"></a>JS 实现</h4><p>因为 JS 实现真的是容易，所以下面直接贴代码（凑字数）：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> uniqueId = <span class="number">1</span>;<span class="comment">//用于回调标示</span></span><br><span class="line"><span class="keyword">let</span> callbacks = &#123;&#125;;<span class="comment">//保存 回调</span></span><br><span class="line"><span class="keyword">let</span> handlers = &#123;&#125;;<span class="comment">//Native 调用的处理集合</span></span><br><span class="line"><span class="comment">// 注册 handler ,需要一个 handlerName 进行标识</span></span><br><span class="line"><span class="keyword">let</span> <span class="title function_">registerJSHandler</span> = (<span class="params">handlerName, handler</span>) =&gt; &#123;</span><br><span class="line">    handlers[handlerName] = &#123;</span><br><span class="line">        <span class="attr">handleNativeCall</span>: <span class="function">(<span class="params">request</span>) =&gt;</span> &#123;</span><br><span class="line">            handler.<span class="title function_">handle</span>(request, &#123;</span><br><span class="line">                <span class="attr">success</span>: <span class="function">(<span class="params">body = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">                    pivot.<span class="title function_">responseFromJS</span>(request.<span class="property">callback_id</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">                        <span class="attr">status</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">msg</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">                        <span class="attr">body</span>: body</span><br><span class="line">                    &#125;));</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">failed</span>: <span class="function">(<span class="params">msg = <span class="string">&quot;failed&quot;</span></span>) =&gt;</span> &#123;</span><br><span class="line">                    pivot.<span class="title function_">responseFromJS</span>(request.<span class="property">callback_id</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">                        <span class="attr">status</span>: <span class="number">1</span>,</span><br><span class="line">                        <span class="attr">msg</span>: msg,</span><br><span class="line">                        <span class="attr">body</span>: &#123;&#125;</span><br><span class="line">                    &#125;));</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">cancel</span>: <span class="function">(<span class="params">reason = <span class="string">&#x27;canceled&#x27;</span></span>) =&gt;</span> &#123;</span><br><span class="line">                    pivot.<span class="title function_">responseFromJS</span>(request.<span class="property">callback_id</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">                        <span class="attr">status</span>: <span class="number">2</span>,</span><br><span class="line">                        <span class="attr">msg</span>: reason,</span><br><span class="line">                        <span class="attr">body</span>: &#123;&#125;</span><br><span class="line">                    &#125;))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//调用 Native 功能的方法，需要 Native 端的 handler标识 和 参数</span></span><br><span class="line"><span class="comment">//这里使用 Promise 来使得调用流程更加方便</span></span><br><span class="line"><span class="keyword">let</span> <span class="title function_">callNative</span> = (<span class="params">handlerName, params = &#123;&#125;</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> callbackId = uniqueId++;</span><br><span class="line">    <span class="keyword">const</span> request = &#123;</span><br><span class="line">        <span class="attr">handler_name</span>: handlerName,</span><br><span class="line">        <span class="attr">callback_id</span>: callbackId,</span><br><span class="line">        <span class="attr">params</span>: params</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            callbacks[callbackId] = &#123;</span><br><span class="line">                <span class="attr">onResponse</span>: <span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">resolve</span>(response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            pivot.<span class="title function_">callFromJS</span>(handlerName, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(request));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(e);</span><br><span class="line">            <span class="keyword">delete</span> callbacks[callbackId];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//通过定义 straw 来将模块中的函数暴露出去</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">straw</span> = &#123;</span><br><span class="line">    <span class="attr">callNative</span>: callNative,</span><br><span class="line">    <span class="attr">registerJSHandler</span>: registerJSHandler</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//called by native code</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">callFromNative</span> = <span class="function">(<span class="params">request</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> handlerName = request.<span class="property">handler_name</span>;</span><br><span class="line">    <span class="keyword">if</span> (handlers[handlerName]) &#123;</span><br><span class="line">        handlers[handlerName].<span class="title function_">handleNativeCall</span>(request);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;undefined handler&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//called by native code</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">responseFromNative</span> = <span class="function">(<span class="params">callbackId, response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (callbacks[callbackId]) &#123;</span><br><span class="line">        callbacks[callbackId].<span class="title function_">onResponse</span>(response);</span><br><span class="line">        <span class="keyword">delete</span> callbacks[callbackId];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 因为这段 JS 代码是在页面加载完成之后才进行注入的，JS 端使用时需要监听这个事件的完成</span></span><br><span class="line"><span class="keyword">const</span> event = <span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">&#x27;onStrawInit&#x27;</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">dispatchEvent</span>(event);</span><br></pre></td></tr></table></figure><p>另外，通过 JS 对象的特性，我们可以非常方便的向 Native 端暴露接口，具体代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义 Native 端接口集合</span></span><br><span class="line"><span class="keyword">const</span> nativeApiList = [&#123;</span><br><span class="line">    <span class="string">&quot;funName&quot;</span>:<span class="string">&quot;isLogin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;handlerName&quot;</span>: <span class="string">&quot;loginHandler&quot;</span>,</span><br><span class="line">    <span class="string">&quot;needParams&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="title function_">apiGenerator</span> = (<span class="params">nativeApi</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (nativeApi.<span class="property">needParams</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> straw.<span class="title function_">callNative</span>(nativeApi.<span class="property">handlerName</span>, params);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> straw.<span class="title function_">callNative</span>(nativeApi.<span class="property">handlerName</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//利用 JS 对象类似于键值对的特性动态绑定函数</span></span><br><span class="line"><span class="keyword">let</span> <span class="title function_">apiFactory</span> = (<span class="params">list</span>) =&gt; &#123;</span><br><span class="line">    list.<span class="title function_">forEach</span>(<span class="function">(<span class="params">nativeApi</span>) =&gt;</span> &#123;</span><br><span class="line">        straw[<span class="string">`<span class="subst">$&#123;nativeApi.funName&#125;</span>`</span>] = <span class="title function_">apiGenerator</span>(nativeApi);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//function apiFactory() below should be called after straw.bundle-x.x.x.js is injected</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">straw</span>) &#123;</span><br><span class="line">    <span class="title function_">apiFactory</span>(nativeApiList);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;onStrawInit&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Straw inited&#x27;</span>);</span><br><span class="line">        <span class="title function_">apiFactory</span>(nativeApiList);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Native 要是实现上面的功能就比较蛋疼了！！！</p><h2 id="坑点"><a href="#坑点" class="headerlink" title="坑点"></a>坑点</h2><p>上面大概就是实现 JSBridge 的思路，在这之外还有一些问题需要注意。</p><h3 id="注入时机"><a href="#注入时机" class="headerlink" title="注入时机"></a>注入时机</h3><p>刚刚也说了，JSbridge JS 端代码一般是在客户端本地的，并没直接添加到网页里，所以我们需要将这段 JS 注入网页，最容易想到的就是在页面加载完成的时候进行注入。 <code>webViewClient.onPageFinished()</code> 能够完成网页加载完成的事件，那就继承一个呗。但是考虑到开发者可能还想在这方法里面进行一些其他操作，为了不起冲突，包装一下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JStrawWebViewClient</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> puppetWVC: WebViewClient?, <span class="keyword">private</span> <span class="keyword">var</span> jsUrl: String)</span><br><span class="line">: WebViewClient() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPageFinished</span><span class="params">(view: <span class="type">WebView</span>?, url: <span class="type">String</span>?)</span></span> &#123;</span><br><span class="line">        InjectUtil.injectJS(view, jsUrl)</span><br><span class="line">        puppetWVC?.onPageFinished(view, url)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>puppetWVC 就是用户自己的 WebViewClient 实例。</p><h3 id="注入安全性"><a href="#注入安全性" class="headerlink" title="注入安全性"></a>注入安全性</h3><p>注入非常简单，定义一个 <code>script</code> 节点，将这个节点插入网页就好了：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">script.<span class="property">src</span> = <span class="string">&#x27;$jsUrl&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> firstScript = <span class="variable language_">document</span>.<span class="property">scripts</span>[<span class="number">0</span>];</span><br><span class="line">firstScript.<span class="property">parentNode</span>.<span class="title function_">insertBefore</span>(script,firstScript);</span><br></pre></td></tr></table></figure><p>一看没毛病，觉得完全OK。但是如果这个 jsUrl 是 <code>file:///android_asset/jstraw.js</code> ，并且你加载的网页不是应用内置的，那么 WebView 内核是不会去加载的，因为它会认为是 <strong>网页主动</strong> 想要拿到本地的资源（事实上是被我们注入的）。但是如果 jsUrl 是 <code>https://host/path/jstraw.js</code> 类型，那么 WebView 是会去尝试加载的。</p><p>知道了这些，我们再考虑这些情况，加载一个非本地网页，理想情况是应用内部、SD 卡和网络上的 JS 文件 都能注入。那么怎么才能使得 这三种情况都被满足呢？</p><p>又要用到 WebViewClient 了，这次需要重写的是 <code>shouldInterceptRequest</code> 这个方法，这个方法会在 WebView 请求每一个资源之前调用一次，如果返回 null 那么，WebView 就自己去加载，如果返回 nonnull ，那么WebView 就会使用我们的提供的资源。</p><p>那么，考虑的安全性限制，我们对 jsUrl 来进行一个转换，如果是来自 应用内部 或者 SD 卡，那就对它改造下，改成 WebView 认可的格式，然后我们再在 <code>shouldInterceptRequest</code> 中来解析并返回资源就OK 了。</p><blockquote><p>也可以利用这个方法来接管 WebView 的缓存，使得整个应用的网络请求都能被监控到。</p></blockquote><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/dashMrl/JStraw">完整代码</a></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://juejin.im/entry/577a6f41128fe10056539e03">android 中的 Hybrid 开发</a></p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://quanru.github.io/2016/10/02/%E8%AE%B0%E4%B8%80%E6%AC%A1%20Webview%20Jsbridge%20%E6%8E%A5%E5%8F%A3%E5%B0%81%E8%A3%85/">记一次 Webview Jsbridge 接口封装</a></p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/lzyzsd/JsBridge">JSBridge</a></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">Clsrfish</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://clsrfish.github.io/2018/01/09/766c3d4ae9f8.html">https://clsrfish.github.io/2018/01/09/766c3d4ae9f8.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://clsrfish.github.io" target="_blank">爱吃胡萝卜</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Webview/">Webview</a><a class="post-meta__tags" href="/tags/JSB/">JSB</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2018/01/08/bac07c03beeb.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Docker 安装</div></div></a></div><div class="next-post pull-right"><a href="/2018/01/16/53150f26f1ec.html"><img class="next-cover" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android SDK Manager 命令行工具使用</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/pwa/144.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">Clsrfish</div><div class="author-info__description">互联网，读书，计算机</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">92</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">80</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div><a class="button--animated" id="card-info-btn" href="https://github.com/Clsrfish" rel="external nofollow noreferrer"><i class="fab fa-github"></i><span>GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:clsrfish@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">《置身事内》ing...</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hybrid"><span class="toc-number">1.</span> <span class="toc-text">Hybrid</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="toc-number">2.</span> <span class="toc-text">背景知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Webview"><span class="toc-number">2.1.</span> <span class="toc-text">Webview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebSettings"><span class="toc-number">2.2.</span> <span class="toc-text">WebSettings</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebviewClient"><span class="toc-number">2.3.</span> <span class="toc-text">WebviewClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebChromeClient"><span class="toc-number">2.4.</span> <span class="toc-text">WebChromeClient</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">通信方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E8%80%83%E8%99%91%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">4.</span> <span class="toc-text">需要考虑的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%89%8B"><span class="toc-number">5.</span> <span class="toc-text">动手</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%B1%BB%E8%AF%B4%E6%98%8E"><span class="toc-number">5.1.</span> <span class="toc-text">核心类说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Request-x2F-Response"><span class="toc-number">5.1.1.</span> <span class="toc-text">Request&#x2F;Response</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NativeHandler-lt-in-T-out-R-gt"><span class="toc-number">5.1.2.</span> <span class="toc-text">NativeHandler&lt;in T, out R&gt;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pivot"><span class="toc-number">5.1.3.</span> <span class="toc-text">Pivot</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JStraw"><span class="toc-number">5.1.4.</span> <span class="toc-text">JStraw</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JS-%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.1.5.</span> <span class="toc-text">JS 实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9D%91%E7%82%B9"><span class="toc-number">6.</span> <span class="toc-text">坑点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E6%97%B6%E6%9C%BA"><span class="toc-number">6.1.</span> <span class="toc-text">注入时机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E5%AE%89%E5%85%A8%E6%80%A7"><span class="toc-number">6.2.</span> <span class="toc-text">注入安全性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">7.</span> <span class="toc-text">参考文章</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/29/a22615e5cdae.html" title="LSM-Tree">LSM-Tree</a><time datetime="2023-07-29T13:16:22.000Z" title="发表于 2023-07-29 21:16:22">2023-07-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/17/49937ddf50aa.html" title="Rate-limiting algorithms">Rate-limiting algorithms</a><time datetime="2023-07-17T14:17:28.000Z" title="发表于 2023-07-17 22:17:28">2023-07-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/16/44c822c98a72.html" title="Consistent hashing">Consistent hashing</a><time datetime="2023-07-16T06:24:30.000Z" title="发表于 2023-07-16 14:24:30">2023-07-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/15/f74286649fc7.html" title="Bloom filter">Bloom filter</a><time datetime="2023-07-15T14:19:02.000Z" title="发表于 2023-07-15 22:19:02">2023-07-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/12/524fd56f9760.html" title="Cache problems">Cache problems</a><time datetime="2023-07-12T13:37:02.000Z" title="发表于 2023-07-12 21:37:02">2023-07-12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2023 By Clsrfish</div><div class="framework-info"><span>框架</span> <a href="https://hexo.io" rel="external nofollow noreferrer">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a href="https://github.com/jerryc127/hexo-theme-butterfly" rel="external nofollow noreferrer">Butterfly</a></div><div class="footer_custom_text">Welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><div class="app-refresh" id="app-refresh"><div class="app-refresh-wrap"><label>✨ 网站已更新最新版本 👉</label> <a href="javascript:void(0)" rel="external nofollow noreferrer" onclick="location.reload()">点击刷新</a></div></div><script>function showNotification(){if(GLOBAL_CONFIG.Snackbar){var t="light"===document.documentElement.getAttribute("data-theme")?GLOBAL_CONFIG.Snackbar.bgLight:GLOBAL_CONFIG.Snackbar.bgDark,e=GLOBAL_CONFIG.Snackbar.position;Snackbar.show({text:"已更新最新版本",backgroundColor:t,duration:5e5,pos:e,actionText:"点击刷新",actionTextColor:"#fff",onActionClick:function(t){location.reload()}})}else{var o=`top: 0; background: ${"light"===document.documentElement.getAttribute("data-theme")?"#49b1f5":"#1f1f1f"};`;document.getElementById("app-refresh").style.cssText=o}}"serviceWorker"in navigator&&(navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("controllerchange",(function(){showNotification()})),window.addEventListener("load",(function(){navigator.serviceWorker.register("/sw.js")})))</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="true" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>